@page "/minesweeper"
@using Microsoft.AspNetCore.Components.Web
@using System.Timers
@implements IDisposable

<div class="game-controls">
    <label for="boardSize">Select Board Size: </label>
    <select id="boardSize" @onchange="ChangeBoardSize">
        <option value="8x8">8x8</option>
        <option value="16x16">16x16</option>
        <option value="30x16">30x16</option>
    </select>
    <button @onclick="InitializeGame">Reset Game</button>
</div>

<div class="game-status">
    @if (!string.IsNullOrEmpty(GameMessage))
    {
        <p>@GameMessage</p>
    }
    @if (!GameOver && !FirstClick)
    {
        <p>Time: @elapsedTime seconds</p>
    }
</div>

<div class="best-times">
    <h3>Best Times</h3>
    <ul>
        @foreach (var bestTime in bestTimes)
        {
            <li>@bestTime.Key: @bestTime.Value seconds</li>
        }
    </ul>
</div>

@if (cells != null)
{
    <div class="game-board" @onkeydown="HandleKeyDown" tabindex="0" >
        @for (int row = 0; row < Rows; row++)
        {
            <div class="board-row" >
                @for (int col = 0; col < Columns; col++)
                {
                    var currentRow = row;
                    var currentCol = col;
                    <button @onclick="() => CellClicked(currentRow, currentCol)" @onclick:stopPropagation="true"
                            @oncontextmenu="(e) => HandleRightClick(e, currentRow, currentCol)"
                            class="board-cell" disabled="@cells[row, col].IsRevealed">
                        @GetCellContent(row, col)
                    </button>
                }
            </div>
        }
    </div>
}


@code {
    private int Rows = 8;
    private int Columns = 8;
    private int Mines = 10;
    private Cell[,] cells;
    private string GameMessage = string.Empty;
    private bool GameOver = false;
    private bool FirstClick = true;
    private System.Timers.Timer gameTimer;
    private double elapsedTime = 0;
    private Dictionary<string, double> bestTimes = new();

    private IJSObjectReference module;
    private IJSObjectReference localStorageModule;

    [Inject] private IJSRuntime jsRuntime { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadLocalStorage();
        await LoadBestTimes();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            module = await jsRuntime.InvokeAsync<IJSObjectReference>("import", "./localStorage.js");
            InitializeGame();
        }
    }

    private async Task LoadLocalStorage()
    {
        localStorageModule = await jsRuntime.InvokeAsync<IJSObjectReference>("import", "./localStorage.js");
    }

    private async void HandleRightClick(MouseEventArgs e, int row, int col)
    {
        ToggleFlag(row, col);
    }

    private void ToggleFlag(int row, int col)
    {
        if (!cells[row, col].IsRevealed)
        {
            cells[row, col].IsFlagged = !cells[row, col].IsFlagged;
        }
        StateHasChanged();
    }

    private void SaveBestTime()
    {
        string key = $"{Rows}x{Columns}";
        if (!bestTimes.ContainsKey(key) || elapsedTime < bestTimes[key])
        {
            bestTimes[key] = elapsedTime;
            var jsonBestTimes = System.Text.Json.JsonSerializer.Serialize(bestTimes);
            localStorageModule.InvokeVoidAsync("setItem", "BestTimes", jsonBestTimes);
        }
    }

    private async Task LoadBestTimes()
    {
        var jsonBestTimes = await localStorageModule.InvokeAsync<string>("getItem", "BestTimes");
        if (!string.IsNullOrEmpty(jsonBestTimes))
        {
            bestTimes = System.Text.Json.JsonSerializer.Deserialize<Dictionary<string, double>>(jsonBestTimes);
        }
    }

    public void Dispose()
    {
        gameTimer?.Dispose();
    }

    private void HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "r" || e.Key == "R")
        {
            InitializeGame();
        }
    }

    private void UpdateElapsedTime(object sender, ElapsedEventArgs e)
    {
        elapsedTime++;
        InvokeAsync(StateHasChanged);
    }

    private void ChangeBoardSize(ChangeEventArgs e)
    {
        var selectedSize = e.Value.ToString();
        switch (selectedSize)
        {
            case "8x8":
                Rows = 8;
                Columns = 8;
                Mines = 10;
                break;
            case "16x16":
                Rows = 16;
                Columns = 16;
                Mines = 40;
                break;
            case "30x16":
                Rows = 16;
                Columns = 30;
                Mines = 99;
                break;
        }
        InitializeGame();
    }

    private void InitializeGame()
    {
        cells = new Cell[Rows, Columns];
        for (int row = 0; row < Rows; row++)
        {
            for (int col = 0; col < Columns; col++)
            {
                cells[row, col] = new Cell();
            }
        }
        PlaceMines();
        CalculateAdjacentMines();
        GameMessage = string.Empty;
        GameOver = false;
        FirstClick = true;
        elapsedTime = 0;
        gameTimer?.Stop();
        gameTimer = new System.Timers.Timer(1000);
        gameTimer.Elapsed += UpdateElapsedTime;
    }

    private void PlaceMines()
    {
        var random = new Random();
        int minesPlaced = 0;
        while (minesPlaced < Mines)
        {
            int row = random.Next(Rows);
            int col = random.Next(Columns);
            if (!cells[row, col].IsMine)
            {
                cells[row, col].IsMine = true;
                minesPlaced++;
            }
        }
    }

    private void CalculateAdjacentMines()
    {
        for (int row = 0; row < Rows; row++)
        {
            for (int col = 0; col < Columns; col++)
            {
                if (!cells[row, col].IsMine)
                {
                    int adjacentMines = 0;
                    for (int r = row - 1; r <= row + 1; r++)
                    {
                        for (int c = col - 1; c <= col + 1; c++)
                        {
                            if (r >= 0 && r < Rows && c >= 0 && c < Columns && cells[r, c].IsMine)
                            {
                                adjacentMines++;
                            }
                        }
                    }
                    cells[row, col].AdjacentMines = adjacentMines;
                }
            }
        }
    }

    private void CellClicked(int row, int col)
    {
        if (GameOver || cells[row, col].IsFlagged)
        {
            return;
        }
        if (FirstClick)
        {
            FirstClick = false;
            gameTimer.Start();
            if (cells[row, col].IsMine)
            {
                RepositionMine(row, col);
            }
        }
        if (cells[row, col].IsMine)
        {
            GameOver = true;
            RevealAllMines();
            GameMessage = "Game Over!";
            gameTimer.Stop();
        }
        else
        {
            RevealCell(row, col);
            if (CheckWinCondition())
            {
                GameOver = true;
                GameMessage = "Congratulations, you won!";
                gameTimer.Stop();
                SaveBestTime();
            }
        }
    }

    private void RepositionMine(int row, int col)
    {
        cells[row, col].IsMine = false;
        PlaceMines();
        CalculateAdjacentMines();
    }

    private void RevealCell(int row, int col)
    {
        if (cells[row, col].IsRevealed || cells[row, col].IsFlagged)
        {
            return;
        }
        cells[row, col].IsRevealed = true;
        if (cells[row, col].AdjacentMines == 0)
        {
            for (int r = row - 1; r <= row + 1; r++)
            {
                for (int c = col - 1; c <= col + 1; c++)
                {
                    if (r >= 0 && r < Rows && c >= 0 && c < Columns)
                    {
                        RevealCell(r, c);
                    }
                }
            }
        }
        StateHasChanged();
    }

    private void RevealAllMines()
    {
        //reveal all mines
        for (int row = 0; row < Rows; row++)
        {
            for (int col = 0; col < Columns; col++)
            {
                if (cells[row, col].IsMine)
                {
                    cells[row, col].IsRevealed = true;
                }
            }
        }

    }

    private bool CheckWinCondition()
    {
        for (int row = 0; row < Rows; row++)
        {
            for (int col = 0; col < Columns; col++)
            {
                if (!cells[row, col].IsMine && !cells[row, col].IsRevealed)
                {
                    return false;
                }
            }
        }
        return true;
    }

    private string GetCellContent(int row, int col)
    {
        if (cells[row, col].IsFlagged)
        {
            return "🚩";
        }
        if (!cells[row, col].IsRevealed)
        {
            return " ";
        }
        if (cells[row, col].IsMine)
        {
            return "💣";
        }
        return cells[row, col].AdjacentMines > 0 ? cells[row, col].AdjacentMines.ToString() : string.Empty;
    }

    private class Cell
    {
        public bool IsMine { get; set; }
        public bool IsRevealed { get; set; }
        public bool IsFlagged { get; set; }
        public int AdjacentMines { get; set; }
    }
}

        <style>
    /* Styles for the Minesweeper game */

    /* Styling the game controls */
    .game-controls {
        margin-bottom: 20px;
    }

        .game-controls label {
            margin-right: 10px;
        }

        .game-controls select,
        .game-controls button {
            margin-right: 10px;
        }

    /* Styling the game status section */
    .game-status {
        margin-bottom: 20px;
    }

        .game-status p {
            font-size: 16px;
            font-weight: bold;
        }

    /* Styling the best times section */
    .best-times {
        margin-bottom: 20px;
    }

        .best-times h3 {
            margin-bottom: 10px;
        }

        .best-times ul {
            list-style-type: none;
            padding: 0;
        }

        .best-times li {
            font-size: 14px;
        }

    /* Styling the game board */
    .game-board {
        display: inline-block;
        border: 2px solid #000;
        padding: 10px;
        background-color: #ccc;
        user-select: none;
        cursor: pointer;
    }

    .board-row {
        display: flex;
    }

    .board-cell {
        width: 30px;
        height: 30px;
        margin: 1px;
        padding: 0;
        background-color: #eee;
        border: 1px solid #000;
        font-size: 16px;
        font-weight: bold;
        text-align: center;
        line-height: 30px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

        .board-cell:disabled {
            background-color: #ddd;
            cursor: default;
        }

        .board-cell.flagged {
            background-color: #f00;
            color: #fff;
        }

        .board-cell.mine {
            background-color: #000;
            color: #fff;
        }
</style>